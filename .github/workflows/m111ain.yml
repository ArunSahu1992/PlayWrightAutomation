name: Run Playwright Automation on Windows

on:
  workflow_dispatch:  # manual trigger
  schedule:
    - cron: "0 0,6,12 * * 1"  # every Monday 12AM, 6AM, 12PM

jobs:
  run-playwright:
    runs-on: [self-hosted]

    steps:
     # 4️⃣ Download code as ZIP artifact (bypass checkout issues)
    - name: Download repository artifact
      uses: actions/download-artifact@v4
      with:
        name: PlayWrightAutomation
        path: C:\Temp\PlayWrightAutomation

    # 5️⃣ Extract ZIP safely using 7-Zip
    - name: Extract ZIP safely
      shell: pwsh
      run: |
        $zipFiles = Get-ChildItem -Path "C:\Temp\PlayWrightAutomation" -Filter "*.zip"
        foreach ($zip in $zipFiles) {
            $extractPath = "C:\Temp\PlayWrightAutomation\Extracted"
            if (Test-Path $extractPath) { Remove-Item $extractPath -Recurse -Force -ErrorAction SilentlyContinue }
            & "C:\Program Files\7-Zip\7z.exe" x $zip.FullName -o$extractPath -y
            Write-Host "Extracted $($zip.Name) to $extractPath"
        }

    # 6️⃣ Run Playwright automation
    - name: Run Playwright
      shell: pwsh
      run: |
        cd C:\Temp\PlayWrightAutomation\Extracted
        dotnet build
        dotnet test

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Install Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'

    - name: Install Playwright browsers
      run: |
        dotnet tool restore
        playwright install

    - name: Run Playwright Tests
      run: |
        dotnet build
        dotnet run --configuration Release --project SwatchBharatMission.Automation.Service/SwatchBharatMission.Automation.Service/SwatchBharatMission.Automation.Service.csproj
